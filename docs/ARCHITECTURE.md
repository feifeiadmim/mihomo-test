# 架构文档

## 系统概述

代理节点转换工具是一个高性能的代理配置处理系统，采用模块化架构设计，支持多种代理协议的解析、转换、去重和优化。

## 架构设计原则

### 1. 模块化设计
- 每个功能模块独立开发和测试
- 清晰的接口定义和依赖关系
- 支持插件化扩展

### 2. 性能优先
- 流式处理大数据集
- 智能缓存机制
- 并发控制和内存管理

### 3. 稳定性保障
- 全面的错误处理
- 安全包装器模式
- 监控和健康检查

### 4. 可扩展性
- 插件化解析器架构
- 配置驱动的行为
- 标准化的接口设计

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    应用层 (Application Layer)                │
├─────────────────────────────────────────────────────────────┤
│  interactive-menu.js  │  CLI Interface  │  API Interface    │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                    核心层 (Core Layer)                      │
├─────────────────────────────────────────────────────────────┤
│                ProxyNodeConverter (src/index.js)            │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐  │
│  │ Parser      │ Producer    │ Processor   │ Performance │  │
│  │ Registry    │ Registry    │ Chain       │ Monitor     │  │
│  └─────────────┴─────────────┴─────────────┴─────────────┘  │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                   服务层 (Service Layer)                    │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐  │
│  │ Parsers     │ Converters  │ Utils       │ Monitoring  │  │
│  │ (解析器)     │ (转换器)     │ (工具)       │ (监控)       │  │
│  └─────────────┴─────────────┴─────────────┴─────────────┘  │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                   基础层 (Infrastructure Layer)             │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐  │
│  │ Cache       │ Config      │ Error       │ File        │  │
│  │ System      │ Management  │ Handling    │ System      │  │
│  └─────────────┴─────────────┴─────────────┴─────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 核心模块详解

### 1. 核心转换器 (ProxyNodeConverter)

**位置**: `src/index.js`

**职责**:
- 统一的入口点和API接口
- 协调各个子系统的工作
- 管理处理流程和生命周期

**关键特性**:
- 流式处理支持
- 并发控制
- 性能监控集成
- 错误恢复机制

### 2. 解析器注册表 (ParserRegistry)

**位置**: `src/core/parser-registry.js`

**职责**:
- 管理所有解析器的注册和发现
- 智能解析器选择
- 并发安全的解析调度

**架构特点**:
```javascript
ParserRegistry
├── 解析器管理
│   ├── 注册机制
│   ├── 自动发现
│   └── 优先级排序
├── 解析调度
│   ├── 并发控制
│   ├── 缓存优化
│   └── 错误处理
└── 性能监控
    ├── 统计收集
    ├── 性能分析
    └── 健康检查
```

### 3. 解析器模块 (Parsers)

**位置**: `src/parsers/`

**支持的协议**:
- VMess (V2Ray)
- Trojan
- Shadowsocks
- VLESS
- Hysteria
- WireGuard
- HTTP/HTTPS
- SOCKS5

**解析器架构**:
```javascript
Parser Interface
├── test(content) → boolean
├── parse(content) → Node[]
├── validate(node) → boolean
└── metadata → Object
```

### 4. 转换器模块 (Converters)

**位置**: `src/converters/`

**支持的格式**:
- Clash YAML
- Base64 编码
- JSON 格式
- URL 格式
- 自定义格式

### 5. 工具模块 (Utils)

**位置**: `src/utils/`

#### 去重引擎 (DeduplicationEngine)
- 多种去重策略
- 高性能算法实现
- 统计和分析功能

#### 重命名引擎 (RenameEngine)
- 模板化重命名
- 地区识别
- 批量处理

#### 过滤引擎 (FilterEngine)
- 规则引擎
- 正则表达式支持
- 链式过滤

### 6. 监控系统 (Monitoring)

**位置**: `src/monitoring/`

**功能模块**:
- 系统监控 (SystemMonitor)
- 性能监控 (PerformanceMonitor)
- 日志管理 (LogManager)
- 健康检查 (HealthChecker)

## 数据流架构

### 处理流程

```
输入文件/内容
      │
      ▼
┌─────────────┐
│ 格式检测     │ ← 自动识别输入格式
└─────────────┘
      │
      ▼
┌─────────────┐
│ 解析器选择   │ ← ParserRegistry
└─────────────┘
      │
      ▼
┌─────────────┐
│ 内容解析     │ ← 具体解析器
└─────────────┘
      │
      ▼
┌─────────────┐
│ 节点验证     │ ← 数据验证
└─────────────┘
      │
      ▼
┌─────────────┐
│ 处理器链     │ ← 去重、重命名、过滤
└─────────────┘
      │
      ▼
┌─────────────┐
│ 格式转换     │ ← 输出格式生成
└─────────────┘
      │
      ▼
输出文件/内容
```

### 缓存架构

```
┌─────────────────────────────────────────┐
│              缓存层架构                  │
├─────────────────────────────────────────┤
│  ┌─────────────┬─────────────────────┐  │
│  │ L1 Cache    │ 内存缓存 (LRU)       │  │
│  │ (Hot Data)  │ - 解析结果缓存       │  │
│  │             │ - 配置缓存          │  │
│  └─────────────┴─────────────────────┘  │
│  ┌─────────────┬─────────────────────┐  │
│  │ L2 Cache    │ 持久化缓存          │  │
│  │ (Warm Data) │ - 文件系统缓存       │  │
│  │             │ - 压缩存储          │  │
│  └─────────────┴─────────────────────┘  │
└─────────────────────────────────────────┘
```

## 性能优化策略

### 1. 内存管理

**策略**:
- 流式处理大文件
- 分批处理减少内存峰值
- 智能垃圾回收触发
- 内存阈值监控

**实现**:
```javascript
// 内存监控
class MemoryManager {
  checkMemoryUsage() {
    const usage = process.memoryUsage();
    if (usage.heapUsed > this.threshold) {
      this.triggerCleanup();
    }
  }
}
```

### 2. 并发控制

**策略**:
- 限制并发解析数量
- 智能任务调度
- 资源池管理
- 背压控制

### 3. 缓存优化

**策略**:
- 多级缓存架构
- LRU淘汰算法
- TTL过期机制
- 缓存预热

## 错误处理架构

### 错误分类

```
Error Hierarchy
├── SystemError (系统错误)
│   ├── MemoryError
│   ├── FileSystemError
│   └── NetworkError
├── ApplicationError (应用错误)
│   ├── ParseError
│   ├── ValidationError
│   └── ConfigError
└── UserError (用户错误)
    ├── InputError
    ├── FormatError
    └── ParameterError
```

### 错误处理策略

1. **预防性处理**: 输入验证、类型检查
2. **保护性处理**: 安全包装器、异常捕获
3. **恢复性处理**: 重试机制、降级策略
4. **监控性处理**: 错误追踪、告警机制

## 扩展性设计

### 1. 插件架构

```javascript
// 解析器插件接口
interface ParserPlugin {
  name: string;
  version: string;
  test(content: string): boolean;
  parse(content: string): Node[];
  validate?(node: Node): boolean;
}
```

### 2. 配置驱动

- 运行时配置热更新
- 环境特定配置
- 功能开关控制

### 3. API扩展

- RESTful API接口
- WebSocket实时通信
- GraphQL查询支持

## 安全考虑

### 1. 输入安全

- 内容长度限制
- 格式验证
- 恶意内容检测

### 2. 内存安全

- 内存使用限制
- 缓冲区溢出防护
- 资源泄漏检测

### 3. 执行安全

- 沙箱执行环境
- 权限最小化
- 安全审计日志

## 部署架构

### 1. 单机部署

```
┌─────────────────────────────────┐
│         Application             │
├─────────────────────────────────┤
│  ┌─────────┬─────────────────┐  │
│  │ Core    │ Monitoring      │  │
│  │ Engine  │ System          │  │
│  └─────────┴─────────────────┘  │
├─────────────────────────────────┤
│         File System             │
└─────────────────────────────────┘
```

### 2. 分布式部署

```
┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ Worker 1    │  │ Worker 2    │  │ Worker N    │
├─────────────┤  ├─────────────┤  ├─────────────┤
│ Parser      │  │ Converter   │  │ Monitor     │
│ Engine      │  │ Engine      │  │ Service     │
└─────────────┘  └─────────────┘  └─────────────┘
       │                │                │
       └────────────────┼────────────────┘
                        │
              ┌─────────────────┐
              │ Coordinator     │
              │ Service         │
              └─────────────────┘
```

## 目录结构说明

### 新的目录结构 (v2.0)

```
Clash-V2/
├── src/                    # 核心源代码
├── input/                 # 输入代理节点文件 (新)
├── tests/                 # 测试代码 (重构)
│   ├── unit/              # 单元测试
│   └── run-tests.js       # 测试运行器
├── docs/                  # 项目文档 (新)
├── output/                # 输出文件目录
└── ...
```

**目录职责**:
- `input/` - 存放输入的代理节点文件，用于处理和转换
- `tests/` - 专门用于测试代码，职责单一
- `docs/` - 项目文档，包括API和架构说明

## 版本演进

### v1.x → v2.0 重构要点

1. **架构重构**: 从单体架构到模块化架构
2. **性能优化**: 引入流式处理和智能缓存
3. **稳定性提升**: 完善错误处理和监控系统
4. **可维护性**: 统一代码规范和测试覆盖

### 未来规划 (v3.0)

1. **微服务架构**: 服务拆分和独立部署
2. **云原生支持**: 容器化和Kubernetes支持
3. **AI增强**: 智能解析和优化建议
4. **实时处理**: 流式数据处理能力
